---
title: 'Fechas de nacimiento: Chile'
author: "Cristián Ayala"
date: "4/19/2019"
output: html_document
---

```{r setup, include=FALSE}
library(lubridate)
library(readxl)
library(janitor)
library(knitr)
library(gganimate)
library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

# Lectura de bases de datos

```{r}
nacimientos <- readRDS('data/01-df_nacimientos.rds')
```

# Embarazo adolescente

Embarazo adolecente en tres grupos:

1. 14 años o menos
1. 15 y 17 años
1. 18 a 19 años

Homologar variable de edad de la madre

```{r}
emb_adolecente <- function(edad){
  
  niveles <- c('14 años o menos', '15 o 16 años', '17 o 19 años', 'no EA')
  
  case_when(edad %in%  1:14          ~ '14 años o menos',
            edad %in% 15:16          ~ '15 o 16 años',
            edad %in% 17:19          ~ '17 o 19 años',
            is.na(edad) | edad == 99 ~ NA_character_,
            TRUE                     ~ 'no EA') %>% 
    as_factor() %>% 
    fct_relevel(niveles)
}

nacimientos <- nacimientos %>% 
  mutate(edad_padre = coalesce(edad_padre, edad_p),
         edad_madre = coalesce(edad_madre, edad_m),
         ea_padre = emb_adolecente(edad_padre),
         ea_madre = emb_adolecente(edad_madre))

nacimientos %>% 
  skimr::skim(edad_padre, edad_madre, ea_padre, ea_madre)
```

Eliminar datos missing

```{r}
sum(nacimientos$edad_madre > 60, na.rm = TRUE)
```

```{r}
nacimientos <- nacimientos %>% 
  filter(edad_madre < 60)
```


Distribución de edades de la madre

```{r}
edad_madre_mean <- nacimientos %>% 
  filter(!is.na(ano_nacim)) %>% 
  group_by(ano_nacim) %>% 
  summarise(edad_mean = mean(edad_madre))

gg_edad_madre <- nacimientos %>% 
  filter(!is.na(ano_nacim)) %>% 
  ggplot(aes(x = edad_madre, fill = ea_madre)) + 
  geom_bar() +
  geom_vline(data = edad_madre_mean, aes(xintercept = edad_mean,
                                         group = ano_nacim), 
             alpha = .5) +
  geom_text(data = edad_madre_mean, aes(x = edad_mean, 
                                        y = 1000, 
                                        fill = NULL,
                                        label = round(edad_mean, 1))) +
  scale_fill_viridis_d(name = 'Edad de la madre', end = .75) +
  scale_y_continuous(limits = c(0, NA),
                     labels = function(x) scales::comma(x, decimal.mark = ".", scale = .001)) +
  labs(subtitle = 'Nacimientos en Chile',
       x = 'Edad de la madre',
       y = 'Nacimientos (miles)', 
       caption = 'DESUC, a partir de datos INE')

gg_edad_madre_anim <- gg_edad_madre +
  transition_states(ano_nacim,
                    transition_length = 1,
                    state_length = 3) +
  labs(title = 'Distribución de edad de la madre según año. \nAño {closest_state}')

animate(
  gg_edad_madre_anim,
)

anim_save('01-gg_edad_madre_anim.mp4')
```

```{r}
gg_edad_madre +
  facet_wrap(vars(ano_nacim), ncol = 4) +
  labs(title = 'Distribución de edad de la madre según año.')
```

## Edad padre 

```{r}
gg_edad_madre_padre <- nacimientos %>% 
  filter(!is.na(ano_nacim), !is.na(edad_padre), edad_padre < 99,
         ano_nacim > 2000) %>% 
  ggplot(aes(x = edad_madre, y = edad_padre, colour = as_factor(ano_nacim))) + 
  geom_smooth()

gg_edad_madre_padre
```

## Madres adolecentes por año

```{r}
ea_anos <- bind_rows(nacimientos %>% 
                       count(ano_nacim, ea_madre) %>% 
                       filter(ea_madre != "no EA") %>% 
                       mutate(variable = 'EA'),
                     nacimientos %>% 
                       count(ano_nacim) %>% 
                       mutate(ea_madre = 'Total',
                              variable = 'Total')) %>% 
  filter(!(is.na(ano_nacim) | is.na(ea_madre))) %>% 
  mutate(ea_madre = fct_explicit_na(ea_madre, na_level = 'Total'))

ea_anos <- ea_anos %>% 
  mutate(ano_nacim = lubridate::make_date(year = ano_nacim))

tail(ea_anos)

ea_anos <- ea_anos %>% 
 filter(ano_nacim >= as.Date("1984-01-01"))
```

Tabla de embarazos adolecentes de madres por año

```{r}
ea_anos %>% 
  select(-variable) %>% 
  spread(ea_madre, n) %>% 
  mutate(ano_nacim = year(ano_nacim)) %>% 
  rename(Año = ano_nacim) %>% 
  kable(format.args = list(big.mark = ','))
```

Nacimientos de madres adolecentes respecto del total.


```{r}
ea_anos %>% 
  count(ano_nacim, variable, wt = n) %>% 
  ggplot(aes(x = ano_nacim, y = n, colour = variable)) +
  geom_line() +
  scale_y_continuous(limits = c(0, NA),
                     labels = function(x) scales::comma(x, decimal.mark = ".", scale = .001)) + 
  scale_x_date(date_breaks = '3 year', 
               date_minor_breaks = 'years',
               date_labels = "%Y") +
  scale_color_viridis_d(name = 'Tipo', 
                        end = .75, 
                        labels = c('Nacimiento de adolescente', 'Total nacimientos')) +
  labs(title = 'Nacimientos en Chile entre 1985 y 2017',
       subtitle = 'Total nacimientos y nacimientos adolescente (19 años o menos)',
       caption = 'DESUC, a partir de datos INE',
       x = 'Años',
       y = 'Nacimientos (miles)') +
  theme(legend.position = 'top')
```


Niveles de embarazo adolescente respecto del total de embarazos.

```{r}
theme_desuc <- list(theme_minimal(base_size = 9)) 


grafico <- ea_anos %>% 
  spread(variable, n) %>% 
  fill(Total, .direction = 'up') %>% 
  group_by(ano_nacim) %>% 
  mutate(EA = replace(EA, is.na(EA), sum(EA, na.rm = TRUE)),
         ea_madre = fct_recode(ea_madre, 'Total EA' = 'Total'), 
         prop_ea = EA / Total) %>% 
  ggplot(aes(x = ano_nacim, y = prop_ea, colour = ea_madre)) +
  geom_line() +
  scale_colour_viridis_d(name = 'Edad de la madre', end = .75) +
  scale_y_continuous(limits = c(0, NA),
                     labels = function(x) scales::percent(x, accuracy = 1)) + 
  scale_x_date(date_breaks = '3 year', 
               date_minor_breaks = 'years',
               date_labels = "%Y") +
  labs(title = 'Porcentaje de nacimientos adolescentes en Chile entre 1984 y 2018',
       subtitle = 'Número de nacimientos de madres adolescentes dividido por total de nacimientos',
       caption = 'Fuente: Elaboración propia a partir de datos INE',
       x = 'Años',
       y = 'Porcentaje de nacimientos') +
  theme(legend.position = 'top') +
  theme_desuc
```


```{r}
ggsave('C:/Users/Vicky/Dropbox (DESUC)/Proyectos/3 Politicas Publicas/INJUV - Embarazo Adolescente/Informes/Publicación/Datos Encuesta 2018/nacimientos.pdf', 
       grafico, 
       scale = 3,
       width = 5, height = 3, units = 'cm')
```


## Madres adolecentes por comuna

```{r}
library(sf)
library(desuctools)

df_comunas <- read_sf('../Censo 2017/Censo_2017_cartografia_pais/shapes/COMUNA_C17.shp') %>% 
  mutate_at(vars(region, comuna, provincia), as.integer)
```

```{r}
ea_anos_comuna <- nacimientos %>% 
  filter(ano_nacim > 2000 & comuna != 0) %>% 
  count(ano_nacim, ea_madre, comuna) %>% 
  group_by(comuna, ano_nacim) %>% 
  mutate(total = sum(n),
         prop_ea = 1-n/total) %>% 
  filter(ea_madre == 'no EA') %>% 
  select(-ea_madre) %>% 
  rename(noEA = n) %>% 
  arrange(comuna)

comunas_gran_santiago <- regiones_y_comunas %>% 
  filter(gran_santiago) %>% 
  pull(comuna)

ea_anos_comuna_gs <- ea_anos_comuna %>% 
  filter(comuna %in% comunas_gran_santiago) %>% 
  left_join(df_comunas, 
            by = 'comuna')

gg_ea_gran_santiago <- ea_anos_comuna_gs %>% 
  # filter(ano_nacim == 2017) %>%
  ggplot(aes(fill = prop_ea)) +
  geom_sf() +
  scale_fill_viridis_c(name = 'Proporción\nembarazo\nadolescente',
                       labels = function(x) scales::percent(x, accuracy = 2)) +
  labs(subtitle = 'Nacimientos de menores de 19 años partido por nacimientos totales',
       caption = 'DESUC, a partir de datos INE')

gg_ea_gran_santiago_anim <- gg_ea_gran_santiago +
  transition_states(ano_nacim,
                    transition_length = 1,
                    state_length = 3) +
  labs(title = 'Proporción de embarazo adolescente según año. \nAño {closest_state}')

animate(
  gg_ea_gran_santiago_anim
)
```

